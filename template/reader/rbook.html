{% extends 'reader/rbase.html' %}
{% load static %}
{% block meta %}
<title>{{ book.title }} | Signed Publishing – Read Stories, Novels, and eBooks</title>
<meta name="description" content="{{ book.title }} by {{ book.author.username }} — {{ book.synopsis|truncatechars:150 }}">
<meta name="keywords" content="{{ book.genre }}, {{ book.author.username }}, Signed Publishing, novels, eBooks, online reading">
<meta property="og:title" content="{{ book.title }} | {{ book.author.username }}">
<meta property="og:description" content="{{ book.synopsis|truncatechars:150 }}">
<meta property="og:url" content="https://www.signedpublishing.com/book/{{ book.id }}/">
<meta property="og:image" content="{{ book.coverimage.url }}">
<meta name="twitter:image" content="{{ book.coverimage.url }}">
<meta name="twitter:title" content="{{ book.title }} | Signed Publishing">
<meta name="twitter:description" content="{{ book.synopsis|truncatechars:150 }}">

<script type="application/ld+json">
{
  "@context": "https://schema.org/",
  "@type": "Book",
  "name": "{{ book.bname }}",
  "author": "{{ book.user.username }}",
  "image": "{{ book.coverimage.url }}",
  "genre": "{{ book.genre }}",
  "aggregateRating": {
    "@type": "AggregateRating",
    "ratingValue": "{{ book.rating|default:4.5 }}",
    "reviewCount": "{{ book.reviews.count }}"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Signed Publishing",
    "url": "https://www.signedpublishing.com/"
  }
}
</script>

{% endblock %}
{% block body %}
  {# KEPT: Original font-serif and color theme as requested #}
  <div class="font-serif antialiased text-gray-800 bg-gray-50 min-h-screen">
    <main class="max-w-6xl mx-auto py-12 px-6 lg:px-8">
      <article class="bg-white shadow-xl rounded-2xl overflow-hidden transform transition-all duration-300 hover:shadow-2xl border border-gray-100"> {# Added subtle border for crispness #}
        <div class="lg:flex">
          <!-- Book Cover Section -->
          {# KEPT: Original gradient colors #}
          <aside class="lg:w-1/3 p-8 bg-gradient-to-br from-amber-50 to-orange-100 flex items-center justify-center border-r border-gray-100">
            {% if book.coverimage %}
              <img src="{{ book.coverimage.url }}" alt="Book Cover" class="w-64 md:w-80 aspect-[2/3] object-cover rounded-lg shadow-xl border border-gray-200 transform hover:scale-105 transition-transform duration-500 ease-in-out" />
            {% else %}
              <div class="w-64 md:w-80 aspect-[2/3] flex items-center justify-center bg-gray-200 rounded-lg shadow-lg text-gray-500 text-lg font-semibold border border-gray-300">No Cover</div>
            {% endif %}
          </aside>

          <!-- Book Details Section -->
          <section class="lg:w-2/3 p-8 md:p-10 flex flex-col justify-between">
            <div>
              {# KEPT: Original text colors #}
              <h1 class="text-4xl md:text-5xl font-extrabold text-amber-950 leading-tight mb-4 tracking-tight">{{ book.bname }}</h1>

              {% if book.user or book.genre %}
                <div class="flex flex-wrap items-center gap-x-4 gap-y-2 mb-6 text-lg text-gray-600">
                  {% if book.user %}
                    <span class="font-semibold text-amber-800">By {{ book.user.username }}</span>
                  {% endif %}
                  {% if book.genre %}
                    {# KEPT: Original genre tag colors #}
                    <span class="text-sm px-3 py-1 bg-orange-100 rounded-full italic text-amber-700 border border-orange-200">{{ book.genre }}</span>
                  {% endif %}
                </div>
              {% endif %}

              <!-- Stats -->
              <div class="flex flex-wrap items-center gap-x-6 gap-y-2 mb-8 text-gray-600 text-base">
                {# KEPT: Original icon colors #}
                <span class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z" />
                  </svg>
                  <span>{{ book.views }} views</span>
                </span>
                <span class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-red-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                  </svg>
                  <span id="like-count">{{ total_likes }} likes</span>
                </span>
                <span class="flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-yellow-500" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                  </svg>
                  <span>{{ book.rating|floatformat:1 }}/5 Rating</span>
                </span>
              </div>

              <!-- Description -->
              {% if book.description %}
                {# KEPT: Original prose colors #}
                <div class="prose prose-amber max-w-none text-gray-700 mb-8 leading-relaxed text-base md:text-lg custom-scrollbar max-h-52 overflow-y-auto pr-3">
                  <p>{{ book.description }}</p>
                </div>
              {% endif %}
            </div>

            <!-- Action Buttons -->
            <div class="mt-8 flex flex-wrap gap-4">
              {% if book.chapters.exists %}
                {% if history and history.last_read_chapter %}
                  {# KEPT: Original button colors #}
                  <a href="{% url 'read' book.id history.last_read_chapter.id %}" class="inline-flex items-center justify-center px-8 py-4 border border-transparent text-base font-bold rounded-full shadow-lg text-white bg-amber-700 hover:bg-amber-800 transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>Continue Reading
                  </a>
                {% else %}
                  {# KEPT: Original button colors #}
                  <a href="{% url 'read' book.id book.chapters.first.id %}" class="inline-flex items-center justify-center px-8 py-4 border border-transparent text-base font-bold rounded-full shadow-lg text-white bg-amber-700 hover:bg-amber-800 transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5m0-13.5c-3.132 0-6.286.721-9 2.093V19c2.714 1.372 5.868 2.093 9 2.093s6.286-.721 9-2.093V8.346c-2.714-1.372-5.868-2.093-9-2.093zM12 6.253c3.132 0 6.286.721 9 2.093M12 6.253V1.87M5.772 17.892C5.356 16.48 5 15.012 5 13.5c0-1.512.356-2.98.772-4.392" />
                    </svg>Read Now
                  </a>
                {% endif %}
              {% else %}
                {# KEPT: Original button colors #}
                <button class="inline-flex items-center justify-center px-8 py-4 border border-transparent text-base font-bold rounded-full shadow-lg text-white bg-amber-900 cursor-not-allowed opacity-70">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5m0-13.5c-3.132 0-6.286.721-9 2.093V19c2.714 1.372 5.868 2.093 9 2.093s6.286-.721 9-2.093V8.346c-2.714-1.372-5.868-2.093-9-2.093zM12 6.253c3.132 0 6.286.721 9 2.093M12 6.253V1.87M5.772 17.892C5.356 16.48 5 15.012 5 13.5c0-1.512.356-2.98.772-4.392" />
                  </svg>No Chapters Yet
                </button>
              {% endif %}

              <!-- Bookmark Button -->
              {% if user.is_authenticated %}
                {# KEPT: Original button colors #}
                <a href="{% url 'add_to_collection' book.id %}" class="inline-flex items-center justify-center px-8 py-4 border border-amber-700 text-base font-bold rounded-full shadow-lg text-amber-700 bg-white hover:bg-amber-50 transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105">
                  {% if book.id in collection_books %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-amber-600" fill="currentColor" viewBox="0 0 24 24">
                      <path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z" />
                    </svg>Bookmarked
                  {% else %}
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                    </svg>Bookmark
                  {% endif %}
                </a>
              {% else %}
                {# KEPT: Original button colors #}
                <a href="{% url 'login' %}" class="inline-flex items-center justify-center px-8 py-4 border border-orange-500 text-base font-bold rounded-full shadow-lg text-orange-500 bg-white hover:bg-orange-50 transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-orange-500" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" />
                  </svg>Bookmark
                </a>
              {% endif %}
            </div>
          </section>
        </div>

        <!-- Chapters List Section -->
        {% if book.chapters.exists %}
          <section class="border-t border-gray-200 px-8 md:px-10 py-8 bg-gray-50">
            {# KEPT: Original text and icon colors #}
            <h2 class="text-2xl font-bold text-amber-900 mb-6 flex items-center gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13.5m0-13.5c-3.132 0-6.286.721-9 2.093V19c2.714 1.372 5.868 2.093 9 2.093s6.286-.721 9-2.093V8.346c-2.714-1.372-5.868-2.093-9-2.093zM12 6.253c3.132 0 6.286.721 9 2.093M12 6.253V1.87M5.772 17.892C5.356 16.48 5 15.012 5 13.5c0-1.512.356-2.98.772-4.392" />
              </svg>Chapters
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-80 overflow-y-auto custom-scrollbar pr-2">
              {% for chapter in chapters %}
                {# KEPT: Original hover colors for chapter links #}
                <a href="{% url 'read' book.id chapter.id %}" class="block p-4 bg-white border border-gray-200 rounded-lg shadow-sm hover:shadow-md hover:border-amber-300 transition-all duration-200 group">
                  <p class="text-sm font-semibold text-gray-500 mb-1">Chapter {{ chapter.order }}</p>
                  <h4 class="text-lg font-medium text-amber-800 group-hover:text-amber-950 transition-colors">{{ chapter.title }}</h4>
                </a>
              {% empty %}
                <p class="text-gray-500 italic col-span-full">No chapters have been added to this book yet.</p>
              {% endfor %}
            </div>
          </section>
        {% endif %}

        <!-- Reviews Section - SLEEK, MODERN, PROFESSIONAL (keeping original theme) -->
        <section class="border-t border-gray-200 px-8 md:px-10 py-10 bg-white"> {# Slightly increased padding #}
          {# KEPT: Original text and icon colors #}
          <h2 class="text-3xl font-bold text-amber-900 mb-8 flex items-center gap-3"> {# Larger, bolder title #}
            <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 text-amber-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"> {# Larger icon #}
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 10h.01M12 10h.01M16 10h.01M9 16H5a2 2 0 01-2-2V6a2 2 0 012-2h14a2 2 0 012 2v8a2 2 0 01-2 2h-5l-5 5v-5z" />
            </svg>Reader Reviews (<span id="review-count">{{ book.reviews.count }}</span>)
          </h2>

          <!-- Scrollable Reviews -->
          <div id="reviews-list" class="space-y-6 max-h-[40rem] overflow-y-auto pr-3"> {# Increased max-height for more reviews, added pr-3 for scrollbar space #}
            {% for review in book.reviews.all %}
              <div class="p-6 bg-white border border-gray-200 rounded-lg shadow-md hover:shadow-lg transition-shadow duration-300 relative"> {# Increased padding, softer shadow #}
                <div class="flex justify-between items-start mb-3"> {# Aligned items to start #}
                  <div>
                    <strong class="text-amber-900 text-lg font-semibold">{{ review.user.username }}</strong> {# Darker, bolder username #}
                    <span class="block text-gray-500 text-sm mt-1">{{ review.timestamp|date:"M d, Y" }}</span> {# Added timestamp for professionalism #}
                  </div>
                  <div class="text-yellow-500 text-base flex items-center gap-1">
                    {% for _ in ''|ljust:review.rating %}
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="currentColor" viewBox="0 0 24 24">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                      </svg>
                    {% endfor %}
                    <span class="ml-1 font-medium text-gray-700">{{ review.rating }}/5</span> {# Added text color to rating #}
                  </div>
                </div>

                <p class="text-gray-700 leading-relaxed review-text max-h-20 overflow-hidden cursor-pointer hover:text-gray-900 transition-colors" title="Click to expand"> {# Changed line-clamp to max-height for consistent rendering, added hover effect #}
                  {{ review.review }}
                </p>

                {% if review.user == user or user.is_staff or user == book.user %}
                  <div class="mt-4 flex gap-5 text-sm"> {# Increased gap #}
                    {% if review.user == user %}
                      {# KEPT: Original amber button color, added flex for icon alignment #}
                      <button class="text-amber-700 hover:text-amber-900 font-medium edit-review-btn transition-colors flex items-center" data-id="{{ review.id }}" data-content="{{ review.review }}" data-rating="{{ review.rating }}">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" />
                        </svg>Edit
                      </button>
                    {% endif %}

                    {# KEPT: Original red delete button color #}
                    <button class="text-red-600 hover:text-red-800 font-medium delete-review-btn transition-colors flex items-center" data-id="{{ review.id }}">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1H9a1 1 0 00-1 1v3m3 0h.01" />
                      </svg>Delete
                    </button>
                  </div>
                {% endif %}
              </div>
            {% empty %}
              <p class="text-gray-500 italic p-6 bg-gray-50 border border-gray-200 rounded-lg">
                No reviews yet. Be the first to share your opinion!
              </p>
            {% endfor %}
          </div>

          {% if user.is_authenticated %}
            <form id="review-form" class="mt-12 p-8 bg-amber-50 border border-amber-200 rounded-xl shadow-lg"> {# Increased padding, softer shadow #}
              {# KEPT: Original text colors #}
              <h3 class="text-2xl font-bold text-amber-900 mb-6">Share Your Thoughts</h3> {# Larger, bolder title #}

              <div class="mb-6">
                <label for="rating" class="block mb-3 text-lg font-medium text-gray-700">Your Rating:</label> {# Larger font for label #}
                <div class="flex items-center gap-1" id="rating-stars"> {# Added a div for star rating #}
                  {# KEPT: Original yellow for stars #}
                  {% for i in rating_range %}
                    <input type="radio" id="star{{ i }}" name="rating" value="{{ i }}" class="hidden" {% if forloop.first %}checked{% endif %}>
                    <label for="star{{ i }}" class="text-gray-300 hover:text-yellow-400 cursor-pointer transition-colors duration-200">
                      <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8 fill-current" viewBox="0 0 24 24">
                        <path d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z" />
                      </svg>
                    </label>
                  {% endfor %}
                </div>
              </div>

              <div class="mb-6">
                <label for="review-content" class="block mb-3 text-lg font-medium text-gray-700">Your Review:</label> {# Larger font for label #}
                {# KEPT: Original amber focus ring #}
                <textarea name="review" id="review-content" rows="6" placeholder="What did you think of the book?" class="w-full border border-amber-300 rounded-md px-4 py-3 resize-y focus:ring-2 focus:ring-amber-500 focus:border-amber-500 transition-colors text-gray-800 placeholder-gray-400"></textarea>
              </div>

              {# KEPT: Original amber button colors #}
              <button type="submit" class="w-full sm:w-auto px-8 py-4 bg-amber-700 hover:bg-amber-800 text-white font-bold rounded-full shadow-lg transition-all duration-300 ease-in-out transform hover:-translate-y-1 hover:scale-105">
                Post Review
              </button>
            </form>
          {% else %}
            <p class="text-gray-600 italic mt-12 p-6 bg-gray-50 border border-gray-200 rounded-lg">
              Please <a href="{% url 'login' %}" class="text-amber-700 hover:underline font-semibold">login</a> to post a review. {# KEPT: Original amber link color #}
            </p>
          {% endif %}
        </section>
      </article>
    </main>
  </div>

  <!-- Delete Confirmation Modal (Popup) -->
  <div id="delete-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-lg p-8 shadow-xl max-w-sm w-full transform transition-all duration-300 scale-95 opacity-0" id="delete-modal-content">
      <h3 class="text-xl font-bold text-gray-900 mb-4">Confirm Deletion</h3>
      <p class="text-gray-700 mb-6">Are you sure you want to delete this review? This action cannot be undone.</p>
      <div class="flex justify-end gap-3">
        <button id="cancel-delete" class="px-5 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">Cancel</button>
        <button id="confirm-delete" class="px-5 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors">Delete</button>
      </div>
    </div>
  </div>

  <!-- Review AJAX Script -->
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const reviewForm = document.getElementById('review-form')
      const reviewCountSpan = document.getElementById('review-count')
      const reviewsList = document.getElementById('reviews-list')

      // Star rating interaction
      const ratingStars = document.getElementById('rating-stars');
      if (ratingStars) {
        ratingStars.addEventListener('mouseover', (e) => {
          if (e.target.tagName === 'LABEL') {
            const value = parseInt(e.target.getAttribute('for').replace('star', ''));
            [...ratingStars.children].forEach(child => {
              if (child.tagName === 'LABEL') {
                const childValue = parseInt(child.getAttribute('for').replace('star', ''));
                if (childValue <= value) {
                  child.classList.add('text-yellow-400');
                  child.classList.remove('text-gray-300');
                } else {
                  child.classList.add('text-gray-300');
                  child.classList.remove('text-yellow-400');
                }
              }
            });
          }
        });
        ratingStars.addEventListener('mouseout', () => {
          const checkedStar = ratingStars.querySelector('input[name="rating"]:checked');
          const value = checkedStar ? parseInt(checkedStar.value) : 0;
          [...ratingStars.children].forEach(child => {
            if (child.tagName === 'LABEL') {
              const childValue = parseInt(child.getAttribute('for').replace('star', ''));
              if (childValue <= value) {
                child.classList.add('text-yellow-500'); // Keep checked stars yellow
                child.classList.remove('text-gray-300', 'text-yellow-400');
              } else {
                child.classList.add('text-gray-300');
                child.classList.remove('text-yellow-500', 'text-yellow-400');
              }
            }
          });
        });
        ratingStars.addEventListener('click', (e) => {
          if (e.target.tagName === 'LABEL') {
            const input = document.getElementById(e.target.getAttribute('for'));
            if (input) {
              input.checked = true;
              const value = parseInt(input.value);
               [...ratingStars.children].forEach(child => {
                if (child.tagName === 'LABEL') {
                  const childValue = parseInt(child.getAttribute('for').replace('star', ''));
                  if (childValue <= value) {
                    child.classList.add('text-yellow-500');
                    child.classList.remove('text-gray-300', 'text-yellow-400');
                  } else {
                    child.classList.add('text-gray-300');
                    child.classList.remove('text-yellow-500', 'text-yellow-400');
                  }
                }
              });
            }
          }
        });
         // Initialize stars based on default selected radio
        const initialCheckedStar = ratingStars.querySelector('input[name="rating"]:checked');
        if (initialCheckedStar) {
          const initialValue = parseInt(initialCheckedStar.value);
          [...ratingStars.children].forEach(child => {
            if (child.tagName === 'LABEL') {
              const childValue = parseInt(child.getAttribute('for').replace('star', ''));
              if (childValue <= initialValue) {
                child.classList.add('text-yellow-500');
                child.classList.remove('text-gray-300');
              }
            }
          });
        }
      }

      // Expand/Collapse long reviews
      document.querySelectorAll('.review-text').forEach((el) => {
        // Check if content overflows to apply line-clamp and expand functionality
        if (el.scrollHeight > el.clientHeight) {
          el.classList.add('line-clamp-3'); // Start with line-clamp for consistent initial view
          el.addEventListener('click', () => {
            el.classList.toggle('line-clamp-3');
            // Max-height toggle ensures a smooth expansion/collapse effect
            if (el.classList.contains('line-clamp-3')) {
                el.style.maxHeight = '5rem'; // Equivalent to approx. 3 lines for leading-relaxed text-gray-700
            } else {
                el.style.maxHeight = el.scrollHeight + 'px'; // Expand to full height
            }
          });
        }
      })

      // Post or Replace Review
      reviewForm?.addEventListener('submit', async (e) => {
        e.preventDefault()
        const formData = new FormData(reviewForm)

        try {
          const res = await fetch("{% url 'add_or_edit_review' book.id %}", {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' },
            body: formData
          })
          const data = await res.json()

          if (data.success) {
            location.reload() // Refresh to show updated reviews
          } else {
            alert('Error posting review: ' + (data.error || 'Unknown error'))
          }
        } catch (err) {
          console.error('AJAX Error (post/edit review):', err)
          alert('Something went wrong. Please try again.')
        }
      })

      // Delete Review with Modal (Popup)
      const deleteModal = document.getElementById('delete-modal');
      const deleteModalContent = document.getElementById('delete-modal-content');
      const confirmDeleteBtn = document.getElementById('confirm-delete');
      const cancelDeleteBtn = document.getElementById('cancel-delete');
      let currentReviewToDelete = null;

      document.querySelectorAll('.delete-review-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          currentReviewToDelete = btn.dataset.id;
          deleteModal.classList.remove('hidden');
          // Animate modal in
          setTimeout(() => {
            deleteModalContent.classList.remove('scale-95', 'opacity-0');
            deleteModalContent.classList.add('scale-100', 'opacity-100');
          }, 50);
        });
      });

      cancelDeleteBtn.addEventListener('click', () => {
        // Animate modal out
        deleteModalContent.classList.remove('scale-100', 'opacity-100');
        deleteModalContent.classList.add('scale-95', 'opacity-0');
        setTimeout(() => {
          deleteModal.classList.add('hidden');
          currentReviewToDelete = null;
        }, 300); // Duration matches transition-all duration-300
      });

      confirmDeleteBtn.addEventListener('click', async () => {
        if (!currentReviewToDelete) return;

        try {
          const res = await fetch(`/review/${currentReviewToDelete}/delete/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
          });
          const data = await res.json();

          if (data.success) {
            const reviewElement = document.querySelector(`.delete-review-btn[data-id="${currentReviewToDelete}"]`).closest('div.p-6');
            if (reviewElement) {
              reviewElement.remove();
              if (reviewCountSpan) {
                reviewCountSpan.textContent = parseInt(reviewCountSpan.textContent) - 1;
              }
            }
            // Animate modal out after successful deletion
            deleteModalContent.classList.remove('scale-100', 'opacity-100');
            deleteModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
              deleteModal.classList.add('hidden');
              currentReviewToDelete = null;
            }, 300);
          } else {
            alert(data.error || 'Error deleting review.');
            // Animate modal out even on error
            deleteModalContent.classList.remove('scale-100', 'opacity-100');
            deleteModalContent.classList.add('scale-95', 'opacity-0');
            setTimeout(() => {
              deleteModal.classList.add('hidden');
              currentReviewToDelete = null;
            }, 300);
          }
        } catch (err) {
          console.error('AJAX Error (delete review):', err);
          alert('Something went wrong. Please try again.');
          // Animate modal out on AJAX error
          deleteModalContent.classList.remove('scale-100', 'opacity-100');
          deleteModalContent.classList.add('scale-95', 'opacity-0');
          setTimeout(() => {
            deleteModal.classList.add('hidden');
            currentReviewToDelete = null;
          }, 300);
        }
      });

      // Edit Review (pre-fill form)
      document.querySelectorAll('.edit-review-btn').forEach((btn) => {
        btn.addEventListener('click', () => {
          // Set radio button for rating
          const ratingInput = document.getElementById(`star${btn.dataset.rating}`);
          if (ratingInput) {
            ratingInput.checked = true;
            // Visually update stars
            const value = parseInt(btn.dataset.rating);
            [...ratingStars.children].forEach(child => {
              if (child.tagName === 'LABEL') {
                const childValue = parseInt(child.getAttribute('for').replace('star', ''));
                if (childValue <= value) {
                  child.classList.add('text-yellow-500');
                  child.classList.remove('text-gray-300');
                } else {
                  child.classList.add('text-gray-300');
                  child.classList.remove('text-yellow-500');
                }
              }
            });
          }

          document.getElementById('review-content').value = btn.dataset.content;
          reviewForm.scrollIntoView({ behavior: 'smooth' });
          document.getElementById('review-content').focus();
        });
      });
    });
  </script>
{% endblock %}