{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Submit Chapter</title>
    <link href="{% static 'css/output.css' %}" rel="stylesheet" />
    <script src="https://cdn.tiny.cloud/1/vb9ejvgwxpqtg9gi7bvpie7h3grq2cbsmt5xhvuctb45ubun/tinymce/7/tinymce.min.js"
        referrerpolicy="origin"></script>
</head>

<body class="bg-orange-50 flex items-center justify-center min-h-screen font-sans p-4 md:p-6">
    <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-10 w-full max-w-4xl border border-orange-100 relative">
        <button onclick="closeForm()"
            class="absolute top-4 right-4 text-gray-600 hover:text-black text-xl font-bold">âœ•</button>

        <h1 class="text-3xl font-extrabold text-center text-amber-900 mb-8">Submit Chapter</h1>

        <form method="POST" id="chapter-form">
            {% csrf_token %}

            <!-- Chapter Title -->
            <div class="mb-6">
                <label class="block text-amber-800 font-semibold mb-2" for="chapter-title">
                    Chapter Title
                    <span class="text-sm text-gray-500 font-normal">(max 100 characters)</span>
                </label>
                <input required type="text" name="title" id="chapter-title-input" maxlength="100"
                    placeholder="Enter chapter title" value="{{ chapter.title|default:'' }}"
                    class="w-full px-4 py-2.5 border border-orange-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 transition" />
                <p id="char-count" class="text-xs text-gray-600 mt-1 text-right">0 / 100 characters</p>
            </div>

            <!-- Chapter Content (textarea for TinyMCE) -->
            <div class="mb-6">
                <label class="block text-amber-800 font-semibold mb-2" for="chapter-content">
                    Chapter Content
                </label>
                <textarea required id="chapter-content-editor" name="content"
                    class="hidden">{{ chapter.content|safe }}</textarea>
            </div>

            <button type="submit"
                class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3.5 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-amber-500 mt-4">
                Submit Chapter
            </button>
        </form>
    </div>

    <script>
        tinymce.init({
            selector: '#chapter-content-editor',
            height: 500,
            menubar: false,
            toolbar_mode: 'wrap', // ensures toolbar items never collapse off-screen
            plugins: 'advlist autolink lists link charmap preview anchor searchreplace visualblocks fullscreen insertdatetime table help wordcount',
            toolbar:
                'undo redo | formatselect | fontselect fontsizeselect | bold italic underline forecolor backcolor | alignleft aligncenter alignright alignjustify | bullist numlist outdent indent | link | removeformat | fullscreen',

            paste_as_text: false,
            paste_data_images: false,
            paste_enable_default_filters: false,
            branding: false,
            convert_urls: false,
            content_css: false,
            placeholder: 'Start writing your chapter here...',

            // Add available fonts and sizes
            font_family_formats:
                "Arial=arial,helvetica,sans-serif;" +
                "Georgia=georgia,serif;" +
                "Times New Roman=times new roman,times,serif;" +
                "Trebuchet MS=trebuchet ms,helvetica,sans-serif;" +
                "Verdana=verdana,geneva,sans-serif;" +
                "Courier New=courier new,courier,monospace",

            fontsize_formats:
                "10px 11px 12px 13px 14px 15px 16px 18px 20px 22px 24px 26px 28px 30px 36px 48px 60px",

            content_style: `
  body {
    font-family: Arial, sans-serif;
    font-size: 15px;
    line-height: 1.4;
    color: #333;
    padding: 1rem;
  }
  p {
    margin: 0 0 0.4em 0;
  }
  ul, ol {
    margin: 0 0 0.6em 1.5em;
    padding: 0;
  }
  li {
    margin: 0.2em 0;
  }
  h1, h2, h3, h4, h5, h6 {
    margin: 0.6em 0 0.3em 0;
    line-height: 1.2;
  }
`,

            paste_webkit_styles: "all",
            paste_retain_style_properties: "all",
            valid_elements: '*[*]',
            valid_styles: {
                '*': 'font-weight,font-style,text-decoration,font-size,color,background-color,font-family'
            },

            setup: function (editor) {
                editor.on('input', function () {
                    const count = editor.plugins.wordcount.getCount();
                    // optional word count display
                });
            },

            init_instance_callback: function (editor) {
                document.getElementById('chapter-form').addEventListener('submit', function (e) {
                    if (!editor.getContent({ format: 'text' }).trim()) {
                        e.preventDefault();
                        alert('Please write something before submitting your chapter!');
                        return;
                    }
                });
            }
        });


        // Character counter
        const titleInput = document.getElementById('chapter-title-input');
        const charCount = document.getElementById('char-count');
        titleInput.addEventListener('input', () => {
            charCount.textContent = `${titleInput.value.length} / 100 characters`;
        });
        charCount.textContent = `${titleInput.value.length} / 100 characters`;

        function closeForm() {
            window.history.back();
        }
    </script>
</body>

</html>