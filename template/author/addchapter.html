{% load static %}
<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Submit Chapter</title>
        <link href="{% static 'css/output.css' %}" rel="stylesheet" />
    </head>
    <body class="bg-orange-50 flex items-center justify-center min-h-screen font-sans p-4 md:p-6">
        <div class="bg-white shadow-xl rounded-2xl p-6 sm:p-10 w-full max-w-4xl border border-orange-100 relative">
            <!-- Exit Button -->
            <button onclick="closeForm()"
                    class="absolute top-4 right-4 text-gray-600 hover:text-black text-xl font-bold">✕</button>
            <h1 class="text-3xl font-extrabold text-center text-amber-900 mb-8">Submit Chapter</h1>
            <form method="POST" id="chapter-form">
                {% csrf_token %}
                <!-- Chapter Title -->
                <div class="mb-6">
                    <label class="block text-amber-800 font-semibold mb-2" for="chapter-title">
                        Chapter Title <span class="text-sm text-gray-500 font-normal">(max 100 characters)</span>
                    </label>
                    <input type="text"
                           name="title"
                           id="chapter-title-input"
                           maxlength="100"
                           placeholder="Enter chapter title"
                           value="{{ chapter.title|default:'' }}"
                           class="w-full px-4 py-2.5 border border-orange-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-amber-500 transition" />
                    <p id="char-count" class="text-xs text-gray-600 mt-1 text-right">0 / 100 characters</p>
                </div>
                <!-- Chapter Content Editor -->
                <div class="mb-6 relative">
                    <label class="block text-amber-800 font-semibold mb-2" for="chapter-content">Chapter Content</label>
                    <div class="border border-orange-200 rounded-lg overflow-hidden relative">
                        <!-- Toolbar -->
                        <div class="flex flex-wrap items-center gap-2 p-3 border-b border-orange-200 bg-orange-100">
                            <button type="button"
                                    onclick="toggleFormat(this, 'bold')"
                                    class="toolbar-button px-3 py-1.5 text-sm font-medium rounded-md text-amber-900 bg-white hover:bg-amber-100 border border-orange-200">
                                B
                            </button>
                            <button type="button"
                                    onclick="toggleFormat(this, 'italic')"
                                    class="toolbar-button px-3 py-1.5 text-sm font-medium rounded-md text-amber-900 bg-white hover:bg-amber-100 border border-orange-200">
                                I
                            </button>
                            <button type="button"
                                    onclick="toggleFormat(this, 'underline')"
                                    class="toolbar-button px-3 py-1.5 text-sm font-medium rounded-md text-amber-900 bg-white hover:bg-amber-100 border border-orange-200">
                                U
                            </button>
                            <select onchange="setFont(this.value)"
                                    class="px-3 py-1.5 text-sm border border-orange-200 rounded-md bg-white text-amber-900 w-full sm:w-auto">
                                <option value="Arial">Arial</option>
                                <option value="Times New Roman">Times New Roman</option>
                                <option value="Georgia">Georgia</option>
                                <option value="Courier New">Courier New</option>
                            </select>
                            <p id="word-count" class="text-xs text-gray-600 sm:ml-auto mt-2 sm:mt-0">0 words</p>
                        </div>
                        <!-- Editable Area -->
                        <div id="chapter-content-editor"
                             contenteditable="true"
                             data-placeholder="Start writing your chapter here..."
                             class="p-4 min-h-[350px] sm:min-h-[450px] w-full overflow-y-auto text-gray-800"
                             style="font-family: Arial">{{ chapter.content|safe }}</div>
                    </div>
                </div>
                <!-- Submit -->
                <button type="submit"
                        class="w-full bg-amber-600 hover:bg-amber-700 text-white font-bold py-3.5 rounded-lg transition focus:outline-none focus:ring-2 focus:ring-amber-500 mt-4">
                    Submit
                    Chapter
                </button>
            </form>
        </div>
        <script>
    // DOM Elements
    const titleInput = document.getElementById('chapter-title-input');
    const charCount   = document.getElementById('char-count');
    const editor      = document.getElementById('chapter-content-editor');
    const wordCount   = document.getElementById('word-count');

    // -----------------------------------------------------------------
    // 1. Word Count (reusable)
    // -----------------------------------------------------------------
    function updateWordCount() {
        const text  = editor.innerText.trim();
        const words = text.split(/\s+/).filter(Boolean).length;
        wordCount.textContent = `${words} word${words !== 1 ? 's' : ''}`;
    }

    // -----------------------------------------------------------------
    // 2. Init Counts
    // -----------------------------------------------------------------
    charCount.textContent = `${titleInput.value.length} / 100 characters`;
    updateWordCount();

    // -----------------------------------------------------------------
    // 3. Title Character Counter
    // -----------------------------------------------------------------
    titleInput.addEventListener('input', () => {
        charCount.textContent = `${titleInput.value.length} / 100 characters`;
    });

    // -----------------------------------------------------------------
    // 4. Editor Input → Word Count
    // -----------------------------------------------------------------
    editor.addEventListener('input', updateWordCount);

    // -----------------------------------------------------------------
    // 5. Toolbar: Bold / Italic / Underline
    // -----------------------------------------------------------------
    function toggleFormat(button, command) {
        editor.focus();
        document.execCommand(command, false, null);

        // Visual active state
        button.classList.toggle('bg-amber-600');
        button.classList.toggle('text-white');
        button.classList.toggle('bg-white');
        button.classList.toggle('text-amber-900');
        button.classList.toggle('hover:bg-amber-100');
    }

    // -----------------------------------------------------------------
    // 6. Font Selector
    // -----------------------------------------------------------------
    function setFont(font) {
        editor.focus();
        document.execCommand('fontName', false, font);
    }

    // -----------------------------------------------------------------
    // 7. Close Form
    // -----------------------------------------------------------------
    function closeForm() {
        window.history.back();
    }

    // -----------------------------------------------------------------
    // 8. Paste Sanitizer – clean + enforce default style
    // -----------------------------------------------------------------
    editor.addEventListener('paste', function (e) {
        e.preventDefault();

        const cd   = e.clipboardData || window.clipboardData;
        const html = cd.getData('text/html');
        const text = cd.getData('text/plain');

        let cleaned = text; // fallback

        if (html) {
            const temp = document.createElement('div');
            temp.innerHTML = html;

            // Remove dangerous tags
            ['SCRIPT','STYLE','META','LINK','IFRAME','OBJECT','EMBED','FORM']
                .forEach(tag => temp.querySelectorAll(tag).forEach(el => el.remove()));

            // Clean every node
            temp.querySelectorAll('*').forEach(node => {
                // Strip all attributes except href
                Array.from(node.attributes).forEach(attr => {
                    if (attr.name !== 'href') node.removeAttribute(attr.name);
                });

                // Enforce default typography
                node.style.fontFamily = 'Arial';
                node.style.fontSize   = '';
                node.style.lineHeight = '1.6';
                node.style.margin     = '0';
                node.style.padding    = '0';
            });

            cleaned = temp.innerHTML || text;
        }

        // Convert plain-text line breaks → <p>
        if (!html || cleaned.trim() === '') {
            cleaned = '<p>' + text.replace(/\n/g, '</p><p>') + '</p>';
            cleaned = cleaned.replace(/<p><\/p>/g, '<p><br></p>');
        }

        // Insert
        const sel = window.getSelection();
        if (sel.rangeCount) {
            const range = sel.getRangeAt(0);
            range.deleteContents();
            const frag = range.createContextualFragment(cleaned);
            range.insertNode(frag);
            range.collapse(false);
            sel.removeAllRanges();
            sel.addRange(range);
        }

        setTimeout(updateWordCount, 0);
    });

    // -----------------------------------------------------------------
    // 9. Submit → copy editor HTML to hidden field
    // -----------------------------------------------------------------
    document.getElementById('chapter-form').addEventListener('submit', function () {
        let hidden = document.querySelector('input[name="content"]');
        if (!hidden) {
            hidden = document.createElement('input');
            hidden.type = 'hidden';
            hidden.name = 'content';
            this.appendChild(hidden);
        }
        hidden.value = editor.innerHTML.trim();
    });

    // -----------------------------------------------------------------
    // 10. Sync toolbar button states (Ctrl+B, etc.)
    // -----------------------------------------------------------------
    document.addEventListener('selectionchange', () => {
        if (document.activeElement !== editor) return;

        ['bold','italic','underline'].forEach(cmd => {
            const btn = document.querySelector(`button[onclick="toggleFormat(this, '${cmd}')"]`);
            if (!btn) return;
            const active = document.queryCommandState(cmd);
            btn.classList.toggle('bg-amber-600', active);
            btn.classList.toggle('text-white',   active);
            btn.classList.toggle('bg-white',     !active);
            btn.classList.toggle('text-amber-900', !active);
            btn.classList.toggle('hover:bg-amber-100', !active);
        });
    });

    // -----------------------------------------------------------------
    // 11. Placeholder handling (optional visual cue)
    // -----------------------------------------------------------------
    const placeholder = editor.getAttribute('data-placeholder');
    if (placeholder && !editor.innerText.trim()) {
        editor.classList.add('placeholder');
        editor.innerHTML = `<span class="text-gray-400">${placeholder}</span>`;
    }

    editor.addEventListener('focus', () => {
        if (editor.classList.contains('placeholder')) {
            editor.classList.remove('placeholder');
            editor.innerHTML = '';
        }
    });

    editor.addEventListener('blur', () => {
        if (!editor.innerText.trim()) {
            editor.classList.add('placeholder');
            editor.innerHTML = `<span class="text-gray-400">${placeholder}</span>`;
        }
    });

    // Initial placeholder check
    if (editor.innerHTML.trim() === '' || editor.classList.contains('placeholder')) {
        editor.dispatchEvent(new Event('blur'));
    }
</script>
    </body>
</html>