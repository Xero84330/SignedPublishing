{% extends 'author/abase.html' %}

{% block body %}
  <body class="bg-orange-50 text-amber-950">
    <div class="max-w-6xl mx-auto mt-6 sm:mt-10 p-4 sm:p-8 bg-white rounded-3xl shadow-xl border border-orange-200 flex flex-col md:flex-row gap-4 sm:gap-8 relative overflow-hidden">
      <div class="absolute top-0 left-0 w-full h-1/4 bg-gradient-to-b from-orange-100/50 to-transparent z-0 rounded-t-3xl"></div>

      <div class="flex-shrink-0 w-full md:w-1/3 flex flex-col items-center gap-3 sm:gap-4 z-10 p-3 sm:p-4 bg-white rounded-2xl shadow-lg border border-orange-100">
        <div class="relative w-40 sm:w-52 md:w-72 aspect-[2/3] object-cover rounded-lg shadow-xl overflow-hidden transform transition-transform duration-300 hover:scale-105">
          {% if book.coverimage %}
            <img src="{{ book.coverimage.url }}" alt="{{ book.bname }} Cover" class="w-full h-full object-cover" />
          {% else %}
            <div class="absolute inset-0 flex items-center justify-center bg-gray-200 text-gray-500 text-xs sm:text-sm font-semibold">No Cover Image</div>
          {% endif %}
        </div>

        <h2 class="text-xl sm:text-2xl md:text-3xl font-extrabold text-center mt-2 sm:mt-3 leading-tight">{{ book.bname }}</h2>
        <p class="text-xs sm:text-sm md:text-base text-gray-600 font-medium">by {{ book.user.username }}</p>

        <div class="w-full max-h-48 sm:max-h-60 md:max-h-72 overflow-y-auto p-3 sm:p-4 bg-orange-50 rounded-lg text-xs sm:text-sm md:text-base text-gray-800 border border-orange-100 shadow-inner leading-relaxed scrollbar-hide">
          <h3 class="font-semibold text-amber-900 mb-1 sm:mb-2 border-b pb-1 border-orange-200">Synopsis</h3>
          {{ book.description }}
        </div>

        <div class="flex flex-col sm:flex-row gap-2 sm:gap-3 w-full mt-3 sm:mt-4">
          <a href="{% url 'editbook' book.id %}" class="flex-1 text-center bg-amber-500 text-white font-bold px-3 py-1.5 sm:px-4 sm:py-2 rounded-full hover:bg-amber-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-sm sm:text-base">Edit Book</a>
          <button id="deleteBookBtn" class="flex-1 bg-red-500 text-white font-bold px-3 py-1.5 sm:px-4 sm:py-2 rounded-full hover:bg-red-600 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-sm sm:text-base">Delete Book</button>
        </div>
      </div>

      <div class="w-full md:w-2/3 flex flex-col gap-3 sm:gap-5 z-10">
        <div class="flex justify-between items-center bg-orange-50 p-3 sm:p-4 rounded-xl shadow-sm border border-orange-100">
          <h2 class="text-xl sm:text-2xl md:text-3xl font-extrabold text-amber-900">Chapters</h2>
          <a href="{% url 'addchapter' book.id %}" class="bg-amber-600 text-white font-bold px-3 sm:px-5 py-1.5 sm:py-2 rounded-full hover:bg-amber-700 transition-all duration-300 shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-sm sm:text-base">Add New</a>
        </div>

        <div class="flex flex-col gap-2 sm:gap-3 overflow-y-auto max-h-[250px] sm:max-h-[350px] md:max-h-[450px] p-2 sm:p-3 rounded-xl bg-orange-50 shadow-inner border border-orange-100 scrollbar-hide">
          {% for chapter in chapters %}
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center p-2 sm:p-3 bg-white rounded-lg shadow-sm hover:shadow-md hover:bg-gray-50 transition-all duration-200 border border-gray-100 group">
              <div class="flex items-center w-full sm:w-auto mb-1 sm:mb-0">
                <span class="w-6 sm:w-8 font-bold text-sm sm:text-base md:text-lg text-amber-800">{{ chapter.order }}.</span>
                <span class="flex-1 px-1 sm:px-2 md:px-3 truncate text-sm sm:text-base md:text-lg font-medium text-amber-950 group-hover:text-amber-800 transition-colors">{{ chapter.title }}</span>
              </div>
              <div class="flex gap-1 sm:gap-2 ml-0 sm:ml-auto w-full sm:w-auto">
                <a href="{% url 'edit_chapter' chapter.id %}" class="flex-1 text-center bg-amber-900 text-white text-xs sm:text-sm md:text-sm px-2 sm:px-3 py-1 sm:py-1.5 rounded-full hover:bg-amber-700 transition-all shadow-sm hover:shadow-md transform hover:-translate-y-0.5">Edit</a>
                <button data-url="{% url 'delete_chapter' chapter.id %}" class="delete-chapter-btn flex-1 bg-red-500 text-white text-xs sm:text-sm md:text-sm px-2 sm:px-3 py-1 sm:py-1.5 rounded-full hover:bg-red-600 transition-all shadow-sm hover:shadow-md transform hover:-translate-y-0.5">Delete</button>
              </div>
            </div>
          {% empty %}
            <p class="text-gray-600 text-center p-4 sm:p-6 bg-white rounded-lg shadow-inner border border-gray-100 text-xs sm:text-sm md:text-base">No chapters found for this book. Click "Add Chapter" to create your first one!</p>
          {% endfor %}
        </div>
      </div>
    </div>

    <div id="deleteChapterModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
      <div class="bg-white rounded-2xl p-5 sm:p-6 w-full max-w-sm shadow-2xl text-center border border-orange-200 relative">
        <button id="closeChapterModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl transition-colors">&times;</button>
        <h3 class="text-lg sm:text-xl md:text-2xl font-bold text-amber-800 mb-3 sm:mb-4">Confirm Delete</h3>
        <p class="mb-4 sm:mb-6 text-xs sm:text-sm md:text-base text-gray-700 leading-relaxed">Are you sure you want to delete this chapter? This action cannot be undone.</p>
        <div class="flex justify-center gap-2 sm:gap-3">
          <button id="confirmDeleteChapter" class="bg-red-600 text-white px-4 sm:px-5 py-1.5 sm:py-2 rounded-full hover:bg-red-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-sm sm:text-base">Yes, Delete</button>
          <button id="cancelDeleteChapter" class="bg-gray-300 text-gray-800 px-4 sm:px-5 py-1.5 sm:py-2 rounded-full hover:bg-gray-400 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-sm sm:text-base">Cancel</button>
        </div>
      </div>
    </div>

    <div id="deleteBookConfirmModal" class="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center hidden z-50 p-4">
      <div class="bg-white rounded-2xl p-5 sm:p-6 w-full max-w-sm shadow-2xl text-center border border-orange-200 relative">
        <button id="closeBookModal" class="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl transition-colors">&times;</button>
        <h3 class="text-lg sm:text-xl md:text-2xl font-bold text-amber-800 mb-3 sm:mb-4">Confirm Book Deletion</h3>
        <p class="text-xs sm:text-sm md:text-base text-gray-700 mb-4 sm:mb-5 leading-relaxed">
          Type the book name (<strong class="text-amber-900">{{ book.bname }}</strong>) to confirm deletion:
        </p>
        <input type="text" id="confirmBookNameInput" placeholder="Enter book name exactly" class="w-full p-2 sm:p-3 mb-4 sm:mb-5 border border-orange-300 rounded-lg text-xs sm:text-sm md:text-base focus:outline-none focus:ring-2 sm:focus:ring-3 focus:ring-amber-400 focus:border-transparent transition-all shadow-sm" />
        <div class="flex justify-center gap-2 sm:gap-3">
          <button id="confirmDeleteBookBtn" class="bg-red-600 text-white px-4 sm:px-5 py-1.5 sm:py-2 rounded-full hover:bg-red-700 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-sm sm:text-base">Delete Book</button>
          <button id="cancelDeleteBookBtn" class="bg-gray-300 text-gray-800 px-4 sm:px-5 py-1.5 sm:py-2 rounded-full hover:bg-gray-400 transition-all shadow-md hover:shadow-lg transform hover:-translate-y-0.5 text-sm sm:text-base">Cancel</button>
        </div>
      </div>
    </div>

    <script>
      const deleteBookBtn = document.getElementById('deleteBookBtn')
      const deleteBookConfirmModal = document.getElementById('deleteBookConfirmModal')
      const confirmDeleteBookInput = document.getElementById('confirmBookNameInput')
      const confirmDeleteBookActionBtn = document.getElementById('confirmDeleteBookBtn')
      const cancelDeleteBookActionBtn = document.getElementById('cancelDeleteBookBtn')
      const closeBookModalBtn = document.getElementById('closeBookModal')
      const deleteBookUrl = "{% url 'delete_book' book.id %}"
      const bookName = '{{ book.bname|escapejs }}'
      
      deleteBookBtn.addEventListener('click', () => {
        deleteBookConfirmModal.classList.remove('hidden')
        confirmDeleteBookInput.value = ''
        confirmDeleteBookInput.focus()
      })
      
      cancelDeleteBookActionBtn.addEventListener('click', () => {
        deleteBookConfirmModal.classList.add('hidden')
      })
      
      closeBookModalBtn.addEventListener('click', () => {
        deleteBookConfirmModal.classList.add('hidden')
      })
      
      confirmDeleteBookActionBtn.addEventListener('click', () => {
        const typedName = confirmDeleteBookInput.value.trim()
        const correctName = bookName.trim()
        if (typedName === correctName) {
          window.location.href = deleteBookUrl
        } else {
          alert(`Book name does not match! Please type '${bookName}' exactly to confirm.`)
          confirmDeleteBookInput.focus()
        }
      })
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !deleteBookConfirmModal.classList.contains('hidden')) {
          cancelDeleteBookActionBtn.click()
        }
      })
      
      const deleteButtons = document.querySelectorAll('.delete-chapter-btn')
      const deleteChapterModal = document.getElementById('deleteChapterModal')
      const confirmDeleteChapter = document.getElementById('confirmDeleteChapter')
      const cancelDeleteChapter = document.getElementById('cancelDeleteChapter')
      const closeChapterModalBtn = document.getElementById('closeChapterModal')
      let deleteUrl = null
      
      deleteButtons.forEach((btn) => {
        btn.addEventListener('click', () => {
          deleteUrl = btn.getAttribute('data-url')
          deleteChapterModal.classList.remove('hidden')
        })
      })
      
      cancelDeleteChapter.addEventListener('click', () => {
        deleteChapterModal.classList.add('hidden')
        deleteUrl = null
      })
      
      closeChapterModalBtn.addEventListener('click', () => {
        deleteChapterModal.classList.add('hidden')
        deleteUrl = null
      })
      
      confirmDeleteChapter.addEventListener('click', () => {
        if (deleteUrl) window.location.href = deleteUrl
      })
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && !deleteChapterModal.classList.contains('hidden')) {
          cancelDeleteChapter.click()
        }
      })
    </script>
  </body>
{% endblock %}
